%%% ## Author: Syed Faraz Abrar
%%% ## Twitter: https://twitter.com/farazsth98
%%% ## Description: Grammar for fuzzing JavaScript

%const% MAX_REPEAT_POWER := 2
%const% VARIANCE_MIN := 50
%const% VARIANCE_MAX := 100
%const% VARIABLE_MIN := 2
%const% VARIABLE_MAX := 5

%%% ###########################################################################
%%% ###########################################################################
%%% ####### VALUE SECTION
%%% ####### Only define values here
%%% ####### Use and assign value in declarations as follows: +value+
%%% ####### Use variables in statements as follows: !variable!.bar();
%%% ###########################################################################
%%% ###########################################################################

%section% := value

%%% ######## Generic Values ########

integers :=
	%range%(-64-64)

unsigned := 
	%range%(0-64)

floats :=
	%range%(-64.0-64.0)

strings :=
	%range%(a-z)
	%range%(A-Z)
	%range%(0-9)
	%repeat%(+strings+)

booleans :=
	true
	false

all :=
	+integers+
	+floats+
	"+strings+"
	+booleans+
	{}
	[]
	{'a':+integers+}
	!str!
	!obj!
	!arr!
	+others+

others :=
	NaN
	undefined
	null

unsafeSizes :=
	%range%(0-64)
	255
	256
	127
	128

charCodes :=
	0x%range%(0x0-0xff)
	+charCodes+, +charCodes+

codePoints :=
	%range%(0-999999)

twoIntArgs :=
	%range%(0-64), %range%(0-64)

threeIntArgs :=
	%range%(0-64), %range%(0-64), %range%(0-64)
	
twoFloatArgs :=
	%range%(0.0-64.0), %range%(0.0-64.0)

threeFloatArgs :=
	%range%(0.0-64.0), %range%(0.0-64.0), %range%(0.0-64.0)

%%% ##############################################################################################
%%% ##############################################################################################
%%% ######## Generic Functions ########
%%% ##############################################################################################
%%% ##############################################################################################

genericFuncArrayMap :=
	function(c_val, c_index, c_array) { c_array.+JSArrayInPlaceMethod+ }

genericFuncArraySort :=
	function(c_first, c_second) { c_first < c_second; }
	function(c_first, c_second) { c_first <= c_second; }
	function(c_first, c_second) { c_first >= c_second; }
	function(c_first, c_second) { c_first > c_second; }

%%% ##############################################################################################
%%% ##############################################################################################
%%% ######## JSArrays ########
%%% ## https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array ##
%%% ##############################################################################################
%%% ##############################################################################################

arrayMethods :=
	+JSArrayCallbackMethod+
	+JSArrayInPlaceMethod+
	+JSArrayForLoopUnsafe+

arrayMethodsForLoop :=
	+JSArrayCallbackMethod+
	+JSArrayInPlaceMethod+

%%% ######## Methods with callbacks ########

JSArrayCallbackMethod :=
%%%	+every+
%%%	+filter+
%%%	+find+
%%%	+findIndex+
%%%	+flatMap+
%%%	+forEach+
	+map+
%%%	+reduce+
%%%	+reduceRight+
%%%	+some+
	+sort+

map :=
	map(+genericFuncArrayMap+)

sort :=
	sort()
	sort(+genericFuncArraySort+)
	
%%% ######## Methods that occur in-place ########

JSArrayForLoopUnsafe :=
	+push+
	+splice+
	+unshift+

JSArrayInPlaceMethod :=
	+concat+
	+copyWithin+
%%%	+entries+
	+fill+
	+flat+
	+includes+
	+indexOf+
	+join+
%%%	+keys+
	+lastIndexOf+
	+pop+
	+reverse+
	+shift+
	+slice+
%%%	+toLocaleString+
	+toString+
%%%	+values+

concat :=
	concat()
	concat(!arr!)
	concat(!obj!)

copyWithin :=
	copyWithin(+twoIntArgs+)
	copyWithin(+threeIntArgs+)

flat :=
	flat()
	flat(+all+)

%%%	entries :=

fill :=
	fill(+all+)
	fill(+all+, +twoIntArgs+)

includes :=
	includes(+all+)
	includes(+all+, +unsigned+)

indexOf :=
	indexOf(+all+)
	indexOf(+all+, +unsigned+)

join :=
	join()
	join(+all+)

%%%	keys :=

lastIndexOf :=
	lastIndexOf(+all+)
	lastIndexOf(+all+, +unsigned+)

pop :=
	pop()
	pop(%repeat%(+all+, ", "))

push :=
	push()
	push(%repeat%(+all+, ", "))

reverse :=
	reverse()
	reverse(%repeat%(+all+, ", "))

shift :=
	shift()
	shift(%repeat%(+all+, ", "))

slice :=
	slice()
	slice(+unsigned+)
	slice(+unsigned+, +unsigned+)

splice :=
	splice()
	splice(+unsigned+)
	splice(+unsigned+, +unsigned+)
	splice(+unsigned+, +unsigned+, %repeat%(+all+, ", "))

toString :=
	toString()
	toString(%repeat%(+all+, ", "))

unshift :=
	unshift()
	unshift(%repeat%(+all+, ", "))
	
%%% ##############################################################################################
%%% ##############################################################################################
%%% ######## DataViews ########
%%% ### https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView
%%% ##############################################################################################
%%% ##############################################################################################

DataViewSetArgs :=
	+booleans+
	+integers+
	+floats+
	+all+

DataViewGetMethods :=
    getFloat32
    getFloat64
    getInt16
    getInt32
    getInt8
    getUint16
    getUint32
    getUint8

DataViewSetMethods :=
    setFloat32
    setFloat64
    setInt16
    setInt32
    setInt8
    setUint16
    setUint32
    setUint8

DataViewMethods :=
	+DataViewGetMethods+(%range%(0-4), +booleans+)
	+DataViewGetMethods+(%range%(0-4), +booleans+)
	+DataViewSetMethods+(%range%(0-4), +DataViewSetArgs+, +booleans+)
	+DataViewSetMethods+(%range%(0-4), +DataViewSetArgs+, +others+)

%%% ##############################################################################################
%%% ##############################################################################################
%%% ######## Wrappers ########
%%% ##############################################################################################
%%% ##############################################################################################

initializableObjects :=
	!dv!
	!obj!
	+arrays+

forLoopInit :=
	for (var i = 0; i < +arrays+.length; i++) { +arrays+[i] = +all+; }
	for (var i = 0; i < +unsigned+; i++) { +initializableObjects+[i] = +all+; }

forLoops :=
	for (var i = 0; i < +unsigned+; i++) { +arrays+.+arrayMethods+; }
	for (var i = 0; i < +arrays+.length; i++) { +arrays+.+arrayMethodsForLoop+; }
	+forLoopInit+

arrays :=
	!arr!
	!e_arr!
	!t_arr!

wrapper :=
	+arrays+.+arrayMethods+;
	!dv!.+arrayMethods+;
	!dv!.+DataViewMethods+;
	!obj!.+arrayMethods+;

%%% ###########################################################################
%%% ###########################################################################
%%% ####### VARIABLE SECTION
%%% ####### Only assign variables in this section
%%% ####### For example: @var@ = 42;
%%% ###########################################################################
%%% ###########################################################################

%section% := variable

str :=
	try { var @str@ = "+strings+"; } catch (e) {}
	try { var @str@ = String.fromCharCode(+charCodes+); } catch (e) {}
	try { var @str@ = String.fromCodePoint(+codePoints+); } catch (e) {}

obj :=
	try { var @obj@ = {}; } catch (e) {}
	try { var @obj@ = Object.create(null); } catch (e) {}
	try { var @obj@ = Object.create(!obj!); } catch (e) {}

arr :=
	try { var @arr@ = new Array(%repeat%(+floats+, ", ")); } catch (e) {}
	try { var @arr@ = new Array(%repeat%(+all+, ", ")); } catch (e) {}
	try { var @arr@ = Array.of(%repeat%(+unsigned+, ", ")); } catch (e) {}
	try { var @arr@ = Array.of(%repeat%(+floats+, ", ")); } catch (e) {}
	try { var @arr@ = Array.of(%repeat%(+all+, ", ")); } catch (e) {}

e_arr :=
	try { var @e_arr@ = new Array(+unsafeSizes+); } catch (e) {}

t_arr :=
	try { var @t_arr@ = new Int8Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Uint8Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Uint8ClampedArray(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Int16Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Uint16Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Int32Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Uint32Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Float32Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Float64Array(+unsafeSizes+); } catch (e) {}
	try { var @t_arr@ = new Int8Array(!buf!); } catch (e) {}
	try { var @t_arr@ = new Uint8Array(!buf!); } catch (e) {}
	try { var @t_arr@ = new Uint8ClampedArray(!buf!); } catch (e) {}
	try { var @t_arr@ = new Int16Array(!buf!); } catch (e) {}
	try { var @t_arr@ = new Uint16Array(!buf!); } catch (e) {}
	try { var @t_arr@ = new Int32Array(!buf!); } catch (e) {}
	try { var @t_arr@ = new Uint32Array(!buf!); } catch (e) {}
	try { var @t_arr@ = new Float32Array(!buf!); } catch (e) {}
	try { var @t_arr@ = new Float64Array(!buf!); } catch (e) {}

buf :=
	try { var @buf@ = new ArrayBuffer(+unsafeSizes+); } catch (e) {}

dv :=
	try { var @dv@ = new DataView(!buf!); } catch (e) {}

%%% ###########################################################################
%%% ###########################################################################
%%% ####### VARIANCE SECTION
%%% ###########################################################################
%%% ###########################################################################

%section% := variance

main :=
	try { +forLoops+ } catch(e) {}
	try { +wrapper+ } catch(e) {}
